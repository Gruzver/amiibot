<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AMII - LED Controller</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/4.3.7/mqtt.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .title {
            font-size: 2.5rem;
            font-weight: bold;
            color: white;
            text-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            margin-bottom: 10px;
        }

        .subtitle {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1.1rem;
        }

        .connection-status {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 20px;
            border-radius: 25px;
            margin-top: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff4757;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: #2ed573;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2);
        }

        .card-title {
            font-size: 1.2rem;
            color: white;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
        }

        .led-control {
            text-align: center;
        }

        .led-number {
            display: inline-block;
            width: 30px;
            height: 30px;
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            border-radius: 50%;
            line-height: 30px;
            font-weight: bold;
            margin-bottom: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .color-input {
            width: 100px;
            height: 100px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            margin: 0 auto;
            display: block;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s ease;
        }

        .color-input:hover {
            transform: scale(1.1);
        }

        .sync-section {
            grid-column: 1 / -1;
            text-align: center;
        }

        .sync-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .sync-toggle {
            background: linear-gradient(45deg, #3742fa, #2f3542);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .sync-toggle:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .sync-toggle.active {
            background: linear-gradient(45deg, #2ed573, #1dd1a1);
        }

        .master-color {
            width: 80px;
            height: 80px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            opacity: 0.5;
            transition: opacity 0.3s ease;
        }

        .master-color.active {
            opacity: 1;
            border-color: #2ed573;
        }

        .control-buttons {
            grid-column: 1 / -1;
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .btn {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            min-width: 150px;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .btn.off {
            background: linear-gradient(45deg, #2c2c54, #40407a);
        }

        .btn.rainbow {
            background: linear-gradient(45deg, #ff9ff3, #f368e0);
        }

        .btn.party {
            background: linear-gradient(45deg, #feca57, #ff9ff3);
        }

        .btn.wave {
            background: linear-gradient(45deg, #48dbfb, #0abde3);
        }

        .log {
            grid-column: 1 / -1;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        .log-entry {
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 5px;
        }

        .log-entry.success {
            color: #2ed573;
        }

        .log-entry.error {
            color: #ff4757;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            .title {
                font-size: 2rem;
            }

            .grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .sync-controls {
                flex-direction: column;
            }

            .control-buttons {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">AMII</h1>
            <p class="subtitle">LED Controller Panel</p>
            <div class="connection-status">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">Desconectado</span>
            </div>
        </div>

        <div class="grid">
            <div class="card">
                <h3 class="card-title">LED 1</h3>
                <div class="led-control">
                    <div class="led-number">1</div>
                    <input type="color" class="color-input" id="led1Color" value="#ff0000">
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">LED 2</h3>
                <div class="led-control">
                    <div class="led-number">2</div>
                    <input type="color" class="color-input" id="led2Color" value="#00ff00">
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">LED 3</h3>
                <div class="led-control">
                    <div class="led-number">3</div>
                    <input type="color" class="color-input" id="led3Color" value="#0000ff">
                </div>
            </div>

            <div class="card sync-section">
                <h3 class="card-title">Control Sincronizado</h3>
                <div class="sync-controls">
                    <button class="sync-toggle" id="syncToggle">Activar Sincronizaci√≥n</button>
                    <input type="color" class="color-input master-color" id="masterColor" value="#ffffff">
                </div>
            </div>

            <div class="control-buttons">
                <button class="btn off" onclick="turnOffAll()">üî¥ Apagar Todo</button>
                <button class="btn rainbow" onclick="rainbowEffect()">üåà Arco√≠ris</button>
                <button class="btn party" onclick="partyMode()">üéâ Fiesta</button>
                <button class="btn wave" onclick="waveEffect()">üåä Onda</button>
            </div>

            <div class="card">
                <h3 class="card-title">Log de Comandos</h3>
                <div class="log" id="logContainer">
                    <div class="log-entry">Sistema iniciado - Esperando conexi√≥n...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuraci√≥n MQTT
        // Usa wss para conexi√≥n segura por WebSockets
        const MQTT_BROKER = "broker.hivemq.com";
        const MQTT_PORT = 8884; // Puerto seguro para WebSockets (wss)
        const CONTROL_TOPIC = "esp32_amii/control/leds";
        
        let client = null;
        let isConnected = false;
        let isSyncMode = false;
        let effectRunning = false;

        // Elementos DOM
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const syncToggle = document.getElementById('syncToggle');
        const masterColor = document.getElementById('masterColor');
        const logContainer = document.getElementById('logContainer');

        // Inicializar conexi√≥n MQTT
        function initMQTT() {
            // Generar un ID de cliente √∫nico para evitar conflictos
            const clientId = "amii_web_" + Math.random().toString(16).substr(2, 8);
            const host = `wss://${MQTT_BROKER}:${MQTT_PORT}/mqtt`;
            
            addLog('üöÄ Iniciando conexi√≥n con ' + host + '...');
            
            client = mqtt.connect(host, { clientId: clientId });

            // Manejadores de eventos de conexi√≥n
            client.on('connect', () => {
                isConnected = true;
                statusDot.classList.add('connected');
                statusText.textContent = 'Conectado';
                addLog('‚úÖ Conectado al broker MQTT', 'success');
            });
            
            client.on('reconnect', () => {
                addLog('üîÑ Reintentando conexi√≥n...', 'info');
            });
            
            client.on('error', (error) => {
                isConnected = false;
                statusDot.classList.remove('connected');
                statusText.textContent = 'Error';
                addLog('‚ùå Error de conexi√≥n: ' + error.message, 'error');
            });

            client.on('close', () => {
                isConnected = false;
                statusDot.classList.remove('connected');
                statusText.textContent = 'Desconectado';
                addLog('‚ö†Ô∏è Conexi√≥n cerrada', 'error');
            });

            client.on('offline', () => {
                isConnected = false;
                statusDot.classList.remove('connected');
                statusText.textContent = 'Desconectado';
                addLog('‚ö†Ô∏è Sin conexi√≥n a internet', 'error');
            });
            
            // Manejador para mensajes entrantes (√∫til si tu ESP32 responde)
            client.on('message', (topic, message) => {
                addLog(`üì® Mensaje recibido en ${topic}: ${message.toString()}`, 'info');
            });
        }

        // Funci√≥n para enviar comandos
        function sendCommand(command) {
            if (!isConnected) {
                addLog('‚ùå No conectado al broker', 'error');
                return;
            }

            try {
                const payload = JSON.stringify(command);
                client.publish(CONTROL_TOPIC, payload, {}, (error) => {
                    if (error) {
                        addLog('‚ùå Error al publicar: ' + error.message, 'error');
                    } else {
                        addLog('üì§ Comando enviado: ' + payload, 'success');
                    }
                });
            } catch (error) {
                addLog('‚ùå Error enviando comando: ' + error.message, 'error');
            }
        }

        // Funci√≥n para agregar logs
        function addLog(message, type = '') {
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = new Date().toLocaleTimeString() + ' - ' + message;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // Convertir hex a RGB
        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? [
                parseInt(result[1], 16),
                parseInt(result[2], 16),
                parseInt(result[3], 16)
            ] : [0, 0, 0];
        }

        // Event listeners para controles individuales
        document.getElementById('led1Color').addEventListener('change', function() {
            if (!isSyncMode) {
                const color = hexToRgb(this.value);
                sendCommand({led: 0, color: color});
            }
        });

        document.getElementById('led2Color').addEventListener('change', function() {
            if (!isSyncMode) {
                const color = hexToRgb(this.value);
                sendCommand({led: 1, color: color});
            }
        });

        document.getElementById('led3Color').addEventListener('change', function() {
            if (!isSyncMode) {
                const color = hexToRgb(this.value);
                sendCommand({led: 2, color: color});
            }
        });

        // Control de sincronizaci√≥n
        syncToggle.addEventListener('click', function() {
            isSyncMode = !isSyncMode;
            
            if (isSyncMode) {
                this.textContent = 'Desactivar Sincronizaci√≥n';
                this.classList.add('active');
                masterColor.classList.add('active');
                addLog('üîÑ Modo sincronizaci√≥n activado');
            } else {
                this.textContent = 'Activar Sincronizaci√≥n';
                this.classList.remove('active');
                masterColor.classList.remove('active');
                addLog('üîÑ Modo sincronizaci√≥n desactivado');
            }
        });

        // Control maestro
        masterColor.addEventListener('change', function() {
            if (isSyncMode) {
                const color = hexToRgb(this.value);
                sendCommand({all: color});
                
                // Sincronizar colores individuales
                document.getElementById('led1Color').value = this.value;
                document.getElementById('led2Color').value = this.value;
                document.getElementById('led3Color').value = this.value;
            }
        });

        // Funciones de efectos
        function turnOffAll() {
            if (effectRunning) return;
            sendCommand({all: [0, 0, 0]});
            addLog('üí° Todos los LEDs apagados');
        }

        async function rainbowEffect() {
            if (effectRunning) return;
            effectRunning = true;
            addLog('üåà Iniciando efecto arco√≠ris...');

            const colors = [
                [255, 0, 0],    // Rojo
                [255, 127, 0],  // Naranja
                [255, 255, 0],  // Amarillo
                [0, 255, 0],    // Verde
                [0, 0, 255],    // Azul
                [75, 0, 130],   // √çndigo
                [148, 0, 211]   // Violeta
            ];

            for (let cycle = 0; cycle < 10; cycle++) {
                for (let color of colors) {
                    sendCommand({all: color});
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
            }

            sendCommand({all: [0, 0, 0]});
            effectRunning = false;
            addLog('üåà Efecto arco√≠ris completado');
        }

        async function partyMode() {
            if (effectRunning) return;
            effectRunning = true;
            addLog('üéâ Iniciando modo fiesta...');

            for (let i = 0; i < 20; i++) {
                const leds = [];
                for (let j = 0; j < 3; j++) {
                    leds.push([
                        Math.floor(Math.random() * 256),
                        Math.floor(Math.random() * 256),
                        Math.floor(Math.random() * 256)
                    ]);
                }
                sendCommand({leds: leds});
                await new Promise(resolve => setTimeout(resolve, 300));
            }

            sendCommand({all: [0, 0, 0]});
            effectRunning = false;
            addLog('üéâ Modo fiesta completado');
        }

        async function waveEffect() {
            if (effectRunning) return;
            effectRunning = true;
            addLog('üåä Iniciando efecto onda...');

            const wave = [
                [[255, 0, 0], [0, 0, 0], [0, 0, 0]],
                [[0, 0, 0], [255, 0, 0], [0, 0, 0]],
                [[0, 0, 0], [0, 0, 0], [255, 0, 0]],
                [[0, 0, 0], [255, 0, 0], [0, 0, 0]],
            ];

            for (let cycle = 0; cycle < 10; cycle++) {
                for (let frame of wave) {
                    sendCommand({leds: frame});
                    await new Promise(resolve => setTimeout(resolve, 200));
                }
            }

            sendCommand({all: [0, 0, 0]});
            effectRunning = false;
            addLog('üåä Efecto onda completado');
        }

        // Inicializar aplicaci√≥n
        window.addEventListener('load', initMQTT);
    </script>
</body>
</html>
