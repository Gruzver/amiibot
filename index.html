<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AMII - LED Controller</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/4.3.7/mqtt.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');

        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --primary-color: #007bff;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --connecting-color: #ffc107;
            --connected-color: #28a745;
            --disconnected-color: #6c757d;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 600px;
            padding: 20px;
            background-color: var(--bg-bg);
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            margin-bottom: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .title {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 5px;
            color: white;
        }

        .subtitle {
            font-size: 1rem;
            color: var(--text-color);
        }

        .status-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 15px;
        }

        .status-dot {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            margin-right: 10px;
            animation: pulse 1.5s infinite;
        }

        .status-text {
            font-weight: 600;
        }

        .status-dot.connected { background-color: var(--connected-color); }
        .status-dot.disconnected { background-color: var(--disconnected-color); animation: none; }
        .status-dot.connecting { background-color: var(--connecting-color); }

        @keyframes pulse {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
        }

        .section-card {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
            color: white;
        }

        .led-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
        }

        .led-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .led-number {
            font-size: 1.1rem;
            font-weight: 500;
            margin-bottom: 10px;
        }

        .color-input {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            transition: transform 0.2s ease;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        
        .color-input::-webkit-color-swatch-wrapper { padding: 0; }
        .color-input::-webkit-color-swatch { border-radius: 50%; border: none; }
        .color-input:active { transform: scale(1.1); }
        
        .sync-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        
        .sync-toggle {
            width: 100%;
            padding: 12px;
            border-radius: 25px;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: background-color 0.3s ease;
        }

        .sync-toggle.active { background-color: var(--success-color); color: white; }
        .sync-toggle:not(.active) { background-color: #333; color: var(--text-color); }
        
        .master-color-container {
            position: relative;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            overflow: hidden;
            border: 2px solid var(--text-color);
            transition: border-color 0.3s ease;
        }

        .master-color-container.active { border-color: var(--success-color); }

        .master-color {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            border: none;
            opacity: 0;
        }

        .master-color-preview {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            transition: background-color 0.3s ease;
        }
        
        .master-color-preview.inactive { opacity: 0.5; }

        .button-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .btn {
            padding: 12px;
            border-radius: 25px;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            color: white;
            transition: transform 0.2s ease;
        }

        .btn:active { transform: scale(0.95); }

        .btn.off { background-color: #444; }
        .btn.rainbow { background-color: #ff69b4; }
        .btn.party { background-color: #ffd700; }
        .btn.wave { background-color: #1e90ff; }
        
        .log-container {
            max-height: 200px;
            overflow-y: auto;
            background-color: #0d0d0d;
            border-radius: 8px;
            padding: 15px;
            font-size: 0.8rem;
            line-height: 1.5;
        }

        .log-entry.success { color: var(--success-color); }
        .log-entry.error { color: var(--danger-color); }
        .log-entry.info { color: var(--connecting-color); }

    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1 class="title">AMII</h1>
            <p class="subtitle">LED Controller Panel</p>
            <div class="status-container">
                <div class="status-dot disconnected" id="statusDot"></div>
                <span class="status-text" id="statusText">Desconectado</span>
            </div>
        </header>

        <main>
            <section class="section-card">
                <h2 class="section-title">Control Individual</h2>
                <div class="led-grid">
                    <div class="led-item">
                        <span class="led-number">LED 1</span>
                        <input type="color" class="color-input" id="led1Color" value="#ff0000">
                    </div>
                    <div class="led-item">
                        <span class="led-number">LED 2</span>
                        <input type="color" class="color-input" id="led2Color" value="#00ff00">
                    </div>
                    <div class="led-item">
                        <span class="led-number">LED 3</span>
                        <input type="color" class="color-input" id="led3Color" value="#0000ff">
                    </div>
                </div>
            </section>

            <section class="section-card">
                <h2 class="section-title">Control Sincronizado</h2>
                <div class="sync-controls">
                    <button class="sync-toggle" id="syncToggle">Activar Sincronización</button>
                    <div class="master-color-container" id="masterColorContainer">
                        <div class="master-color-preview" id="masterColorPreview" style="background-color: #ffffff;"></div>
                        <input type="color" class="master-color" id="masterColor" value="#ffffff">
                    </div>
                </div>
            </section>

            <section class="section-card">
                <h2 class="section-title">Modos de Efectos</h2>
                <div class="button-grid">
                    <button class="btn off" onclick="turnOffAll()">Apagar Todo</button>
                    <button class="btn rainbow" onclick="rainbowEffect()">Arcoíris</button>
                    <button class="btn party" onclick="partyMode()">Modo Fiesta</button>
                    <button class="btn wave" onclick="waveEffect()">Efecto Onda</button>
                </div>
            </section>

            <section class="section-card">
                <h2 class="section-title">Log de Comandos</h2>
                <div class="log-container" id="logContainer">
                    <div class="log-entry">Sistema iniciado - Esperando conexión...</div>
                </div>
            </section>
        </main>
    </div>

    <script>
        // Configuración MQTT
        const MQTT_BROKER = "broker.hivemq.com";
        const MQTT_PORT = 8884;
        const CONTROL_TOPIC = "esp32_amii/control/leds";
        
        let client = null;
        let isConnected = false;
        let isSyncMode = false;
        let effectRunning = false;

        // Elementos DOM
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const syncToggle = document.getElementById('syncToggle');
        const masterColor = document.getElementById('masterColor');
        const masterColorPreview = document.getElementById('masterColorPreview');
        const masterColorContainer = document.getElementById('masterColorContainer');
        const logContainer = document.getElementById('logContainer');

        function initMQTT() {
            const clientId = "amii_web_" + Math.random().toString(16).substr(2, 8);
            const host = `wss://${MQTT_BROKER}:${MQTT_PORT}/mqtt`;
            
            addLog('🚀 Iniciando conexión con ' + host + '...');
            
            client = mqtt.connect(host, { clientId: clientId });

            client.on('connect', () => {
                isConnected = true;
                statusDot.classList.add('connected');
                statusDot.classList.remove('disconnected', 'connecting');
                statusText.textContent = 'Conectado';
                addLog('✅ Conectado al broker MQTT', 'success');
            });
            
            client.on('reconnect', () => {
                statusDot.classList.add('connecting');
                statusText.textContent = 'Reconectando';
                addLog('🔄 Reintentando conexión...', 'info');
            });
            
            client.on('error', (error) => {
                isConnected = false;
                statusDot.classList.add('disconnected');
                statusDot.classList.remove('connected', 'connecting');
                statusText.textContent = 'Error';
                addLog('❌ Error de conexión: ' + error.message, 'error');
            });

            client.on('close', () => {
                isConnected = false;
                statusDot.classList.add('disconnected');
                statusDot.classList.remove('connected', 'connecting');
                statusText.textContent = 'Desconectado';
                addLog('⚠️ Conexión cerrada', 'error');
            });

            client.on('offline', () => {
                isConnected = false;
                statusDot.classList.add('disconnected');
                statusDot.classList.remove('connected', 'connecting');
                statusText.textContent = 'Desconectado';
                addLog('⚠️ Sin conexión a internet', 'error');
            });
            
            client.on('message', (topic, message) => {
                addLog(`📨 Mensaje recibido en ${topic}: ${message.toString()}`, 'info');
            });
        }

        function sendCommand(command) {
            if (!isConnected) {
                addLog('❌ No conectado al broker', 'error');
                return;
            }

            try {
                const payload = JSON.stringify(command);
                client.publish(CONTROL_TOPIC, payload, {}, (error) => {
                    if (error) {
                        addLog('❌ Error al publicar: ' + error.message, 'error');
                    } else {
                        addLog('📤 Comando enviado: ' + payload, 'success');
                    }
                });
            } catch (error) {
                addLog('❌ Error enviando comando: ' + error.message, 'error');
            }
        }

        function addLog(message, type = '') {
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = new Date().toLocaleTimeString() + ' - ' + message;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? [
                parseInt(result[2], 16),
                parseInt(result[1], 16),
                parseInt(result[3], 16)
            ] : [0, 0, 0];
        }

        document.getElementById('led1Color').addEventListener('change', function() {
            if (!isSyncMode) {
                const color = hexToRgb(this.value);
                sendCommand({led: 0, color: color});
            }
        });

        document.getElementById('led2Color').addEventListener('change', function() {
            if (!isSyncMode) {
                const color = hexToRgb(this.value);
                sendCommand({led: 1, color: color});
            }
        });

        document.getElementById('led3Color').addEventListener('change', function() {
            if (!isSyncMode) {
                const color = hexToRgb(this.value);
                sendCommand({led: 2, color: color});
            }
        });

        syncToggle.addEventListener('click', function() {
            isSyncMode = !isSyncMode;
            
            if (isSyncMode) {
                this.textContent = 'Desactivar Sincronización';
                this.classList.add('active');
                masterColorContainer.classList.add('active');
                addLog('🔄 Modo sincronización activado');
            } else {
                this.textContent = 'Activar Sincronización';
                this.classList.remove('active');
                masterColorContainer.classList.remove('active');
                addLog('🔄 Modo sincronización desactivado');
            }
        });

        masterColor.addEventListener('input', function() {
            if (isSyncMode) {
                masterColorPreview.style.backgroundColor = this.value;
            }
        });

        masterColor.addEventListener('change', function() {
            if (isSyncMode) {
                const color = hexToRgb(this.value);
                sendCommand({all: color});
                
                document.getElementById('led1Color').value = this.value;
                document.getElementById('led2Color').value = this.value;
                document.getElementById('led3Color').value = this.value;
            }
        });

        function turnOffAll() {
            if (effectRunning) return;
            sendCommand({all: [0, 0, 0]});
            addLog('💡 Todos los LEDs apagados');
        }

        async function rainbowEffect() {
            if (effectRunning) return;
            effectRunning = true;
            addLog('🌈 Iniciando efecto arcoíris...');
            // ... (rest of the rainbowEffect code)
            const colors = [[255, 0, 0], [255, 127, 0], [255, 255, 0], [0, 255, 0], [0, 0, 255], [75, 0, 130], [148, 0, 211]];
            for (let cycle = 0; cycle < 10; cycle++) {
                for (let color of colors) {
                    sendCommand({all: color});
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
            }
            sendCommand({all: [0, 0, 0]});
            effectRunning = false;
            addLog('🌈 Efecto arcoíris completado');
        }

        async function partyMode() {
            if (effectRunning) return;
            effectRunning = true;
            addLog('🎉 Iniciando modo fiesta...');
            // ... (rest of the partyMode code)
            for (let i = 0; i < 20; i++) {
                const leds = [];
                for (let j = 0; j < 3; j++) {
                    leds.push([Math.floor(Math.random() * 256), Math.floor(Math.random() * 256), Math.floor(Math.random() * 256)]);
                }
                sendCommand({leds: leds});
                await new Promise(resolve => setTimeout(resolve, 300));
            }
            sendCommand({all: [0, 0, 0]});
            effectRunning = false;
            addLog('🎉 Modo fiesta completado');
        }

        async function waveEffect() {
            if (effectRunning) return;
            effectRunning = true;
            addLog('🌊 Iniciando efecto onda...');
            // ... (rest of the waveEffect code)
            const wave = [[[255, 0, 0], [0, 0, 0], [0, 0, 0]], [[0, 0, 0], [255, 0, 0], [0, 0, 0]], [[0, 0, 0], [0, 0, 0], [255, 0, 0]], [[0, 0, 0], [255, 0, 0], [0, 0, 0]]];
            for (let cycle = 0; cycle < 10; cycle++) {
                for (let frame of wave) {
                    sendCommand({leds: frame});
                    await new Promise(resolve => setTimeout(resolve, 200));
                }
            }
            sendCommand({all: [0, 0, 0]});
            effectRunning = false;
            addLog('🌊 Efecto onda completado');
        }

        window.addEventListener('load', initMQTT);
    </script>
</body>
</html>
